<!DOCTYPE html>
<!--suppress JSUnresolvedVariable, JSUnresolvedFunction -->
<html>
<head>
    <title>Torrent Search Engine</title>
</head>

<body>


</body>
</html>
<link href="codebase/bluewater.css" rel="stylesheet" type="text/css">
<link href="codebase/components/sidebar/sidebar.css" rel="stylesheet" type="text/css">
<script src="codebase/webix.js" type="text/javascript"></script>
<script src="codebase/components/sidebar/sidebar.js" type="text/javascript"></script>
<script src="codebase/countup.js" type="text/javascript"></script>
<script src="codebase/underscore.min.js" type="text/javascript"></script>
<script src="codebase/CategoriesHelper.js" type="text/javascript"></script>
<script src="codebase/backbone.min.js" type="text/javascript"></script>
<script src="codebase/TorrentApiAdapter.js" type="text/javascript"></script>
<script src="codebase/TorrentPaginationModelAdapter.js" type="text/javascript"></script>
<script src="codebase/PaginationHelper.js" type="text/javascript"></script>
<style>
    .webix_pager_item, .webix_pager_item_selected {
        margin-left: 5px;
        margin-left: 5px;
        padding: 0 6px;
    }

    .webix_tree_leaves {
        transition: height 0.3s;
        overflow: hidden;
    }
    .vote-btn button{
        padding: 0px 6px;
    }
    .align-right{
        float: right;
    }
    .title-year{
        float: right;
        margin-right: 5px;
    }
    .poster {
        height: auto;
        width: auto;
        max-width: 200px;
        max-height: 300px;
        margin: 5px;

    }
    .app_button button {
        padding: 0 4px;
        text-align: center;
    }

    .treetable-margin {
        margin: 0 0 0 23px;
    }

    .smooth .webix_accordionitem {
        transition: height 0.5s;
    }

    .btnColorLink a {
        color: inherit;
    }

    .closeBtn i {
        font-size: 30px;
    }

    .inline {
        display: inline-block;
        margin: 2px;
        font-size: 1.3em;
    }
</style>
<script type="text/javascript">
    webix.ready(function () {

        webix.protoUI({
            name:"activeDataView" //give it some name you like
        },webix.ui.dataview, webix.ActiveContent);
        var torrentsEndpoint = webix.proxy("torrentApi", "/torrents/");

        function performSearch(query) {
            var table = $$("torrentsList");


            torrentsEndpoint.params.searchTerm = query;
            torrentsEndpoint.params.groupId = 0;
            $$('sidebar').unselectAll();
            $$('torrentListContainer').show()
            table.clearAll();
            table.load(table.config.url);
        }

        function changeGroup(groupId) {
            var table = $$("torrentsList");


            torrentsEndpoint.params.groupId = groupId;
            torrentsEndpoint.params.searchTerm = '';
            $$("search").setValue('');

            table.clearAll();
            table.load(table.config.url);

        }

        function formatBytes(bytes, decimals) {
            if (bytes == 0) return '0 Byte';
            var k = 1000; // or 1024 for binary
            var dm = decimals + 1 || 3;
            var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
            var i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        var statsWindow = webix.ui({
            id: 'statsWindow',
            view: "window",
            height: 550,
            width: 850,
            modal: true,
            animate: {type: "flip", subtype: "vertical"},
            head: {
                view: "toolbar", padding: 3, elements: [
                    {view: "label", label: "Torrent Indexing Statistic"},
                    {
                        view: "button",
                        align: 'right',
                        css: 'closeBtn',
                        cursor: 'hand',
                        template: '<span class="webix_icon fa-close" ></span>',
                        click: function () {
                            statsWindow.hide();
                            $$('sidebar').unselectAll();
                            Backbone.history.history.back();
                        }
                    }
                ]
            },
            position: "center",
            body: {
                type: 'space',
                rows: [
                    {
                        view: "tabview",
                        cells: [
                            {
                                header: 'Torrents Count',
                                body: {
                                    id: "torrentCountChart",
                                    view: 'chart',
                                    type: 'line',
                                    select: true,
                                    line: {
                                        color: "#1293f8",
                                        width: 3
                                    },
                                    padding: {
                                        left: 75
                                    },
                                    xAxis: {
                                        template: function (item) {
                                            return new Date(Date.parse(item.Date)).getHours() + ':00';
                                        },
                                        title: 'Time'
                                    },
                                    yAxis: {
                                        title: 'The Number of Torrents',
                                        template: function (item) {
                                            return webix.i18n.intFormat(item);
                                        }
                                    },
                                    series: [
                                        {   // 1st Torrents
                                            value: function (item) {
                                                return item.TorrentsCount;
                                            },
                                            item: {
                                                color: "#58dccd"
                                            },
                                            line: {
                                                color: "#58dccd"
                                            }
                                        }
                                    ],
                                    tooltip: {
                                        template: function (obj) {
                                            return webix.i18n.intFormat(obj.TorrentsCount)
                                        }
                                    }
                                }
                            },
                            {
                                header: 'Files Count',
                                body: {
                                    id: "filesCountChart",
                                    view: 'chart',
                                    type: 'line',
                                    line: {
                                        color: "#1293f8",
                                        width: 3
                                    },
                                    padding: {
                                        left: 95
                                    },
                                    xAxis: {
                                        template: function (item) {
                                            return new Date(Date.parse(item.Date)).getHours() + ':00'
                                        },
                                        title: 'Time'
                                    },
                                    yAxis: {
                                        title: 'The Number of Files',
                                        template: function (item) {
                                            return webix.i18n.intFormat(item);
                                        }
                                    },
                                    series: [
                                        {   // 1st Torrents
                                            value: function (item) {
                                                return item.FilesCount;
                                            },
                                            item: {
                                                color: "#a7ee70"
                                            },
                                            line: {
                                                color: "#a7ee70"
                                            }
                                        }
                                    ],
                                    tooltip: {
                                        template: function (obj) {
                                            return webix.i18n.intFormat(obj.FilesCount)
                                        }
                                    }
                                }
                            },
                            {
                                header: 'Total File Size',
                                body: {
                                    id: "totalFilesSizeChart",
                                    view: 'chart',
                                    type: 'line',
                                    line: {
                                        color: "#1293f8",
                                        width: 3
                                    },
                                    padding: {
                                        left: 95
                                    },
                                    xAxis: {
                                        template: function (item) {
                                            return new Date(Date.parse(item.Date)).getHours() + ':00'
                                        },
                                        title: 'Time'
                                    },
                                    yAxis: {
                                        template: function (item) {
                                            return formatBytes(item, 4);
                                        },
                                        title: 'Total Files Size'
                                    },
                                    series: [
                                        {   // 1st Torrents
                                            value: function (item) {
                                                return item.TotalFilesSize;
                                            },
                                            item: {
                                                color: "#36abee"
                                            },
                                            line: {
                                                color: "#36abee"
                                            }
                                        }
                                    ],
                                    tooltip: {
                                        template: function (obj) {
                                            return formatBytes(obj.TotalFilesSize,4)
                                        }
                                    }
                                }
                            }
                        ]
                    }
                ]
            }
        });

        var routes = new (Backbone.Router.extend({
            routes: {
                "": "index",
                "stats/": "showStats",
                "group/:groupId": "groupPaged",
                "search/:term": "search",
            },
            index: function () {
                $$('torrentListPage').show();
            },
            showStats: function () {
                webix.ajax('/torrents/stats/', function (text, dataAdapter) {
                    var json = dataAdapter.json();
                    var torrentCountChart = $$('torrentCountChart');
                    torrentCountChart.clearAll();
                    torrentCountChart.parse(json);
                    var filesCountChart = $$('filesCountChart');
                    filesCountChart.clearAll();
                    filesCountChart.parse(json);
                    var totalFilesSizeChart = $$('totalFilesSizeChart');
                    totalFilesSizeChart.clearAll();
                    totalFilesSizeChart.parse(json);
                    statsWindow.show();
                })
            },

            groupPaged: function (groupId) {
                $$('torrentListPage').show();
                changeGroup(groupId);


            },
            search: function (query) {
                $$('torrentListPage').show();
                performSearch(query);
                if ($$("search").getValue() != query) {
                    $$("search").setValue(query);
                }
            },

        }));


        webix.ui({
            rows: [
                {
                    view: 'toolbar',
                    paddingY: 0,
                    paddingX: 0,
                    elements: [
                        {
                            id: "humburgerButton", css: "app_button",
                            view: "button", type: "icon", icon: "bars",
                            width: 38,

                            click: function () {
                                $$("sidebar").toggle()
                            }
                        },
                        {
                            id: "backButton", css: "app_button",
                            view: "button", type: "icon", icon: "arrow-circle-o-left",
                            width: 38,
                            click: function () {
                                $$("pagesContainer").back();
                            }
                        },
                        {
                            view: "label",
                            label: "Torrent Search Engine",
                        },
                        {},
                        {
                            view: "search",
                            keyPressTimeout: 1200,
                            align: "left",
                            width: 400,
                            placeholder: "Search..",
                            id: "search",
                        }]


                },
                {
                    cols: [
                        {
                            id: "sidebar",
                            view: "sidebar",
                            collapsed: true,
                            on: {
                                onItemClick: function () {
                                    console.log(arguments);
                                },
                                onAfterSelect: function (id) {
                                    if (this.getItem(id).value == "Stats") {
                                        routes.navigate("stats/", {trigger: true});
                                        $$('sidebar').getPopup().hide();
                                    } else {
                                        var itemId = this.getItem(id).Id;
                                        if (itemId < 212) {
                                            changeGroup(itemId);
                                            if (itemId == 0) {
                                                routes.navigate('')
                                            } else {
                                                routes.navigate('group/' + itemId)
                                            }
                                        }
                                    }
                                },
                                onAfterOpen: function (id) {
                                    var node = this.getItemNode(id);
                                    var height = node.nextSibling.offsetHeight;
                                    node.nextSibling.style.height = "1px";
                                    webix.delay(function () {
                                        node.nextSibling.style.height = height + "px";
                                    });
                                },
                                onBeforeClose: function (id) {
                                    if (this._in_animation) {
                                        this._in_animation = false;
                                        return true;
                                    }

                                    var node = this.getItemNode(id);
                                    node.nextSibling.style.height = "1px";

                                    webix.delay(function () {
                                        this.close(id);
                                    }, this, [], 300);
                                    this._in_animation = true;
                                    return false;
                                },
                            }
                        },
                        {
                            id: "pagesContainer",
                            view: 'multiview',
                            cols: [
                                {
                                    id: 'torrentListPage',
                                    css: 'smooth',
                                    multi: true,
                                    rows: [
                                        {
                                            cols: [
                                                {
                                                    type: 'header',
                                                    template: 'Torrents'
                                                },
                                                {
                                                    id: 'infoContainer',
                                                    view: 'label',
                                                    align: 'right',
                                                    template: '<div class="inline"><div class="inline" id="torrentsCountUp"></div><div class="inline" id="filesCountUp"></div></div>'
                                                }
                                            ]
                                        },
                                        {
                                            id: 'torrentListContainer',
                                            rows: [
                                                {
                                                    id: "torrentsList",
                                                    view: "datatable",
                                                    datatype: "torrentsAdapter",
                                                    scrollX: false,
                                                    url: torrentsEndpoint,
                                                    datafetch: 40,
                                                    select: 'row',
                                                    columns: [
                                                        {
                                                            id: 'magnet',
                                                            header: '<span class="webix_icon fa-download " aria-hidden="true"></span>',
                                                            template: '<a style="color:#cf3636" title="Download" href="magnet:?xt=urn:btih:#Infohash#&tr=udp://tracker.coppersurfer.tk:6969/announce&tr=udp://open.demonii.com:1337/announce&tr=udp://tracker.openbittorrent.com:80&tr=http://tracker.opentrackr.org:1337/announce&tr=http://explodie.org:6969/announce"><span class="webix_icon fa-download" aria-hidden="true"></span></a>',
                                                            width: 40,
                                                        },
                                                        {
                                                            id: "name",
                                                            header: "Name",
                                                            fillspace: true,
                                                            template: "#Name#"
                                                        },
                                                        {
                                                            id: "seeds",
                                                            header: '<span style="font-size: 18px" class="fa fa-arrow-circle-up"></span>',
                                                            width: 70,
                                                            template: function (obj) {
                                                                if (obj.Seeds > -1) {
                                                                    return obj.Seeds;
                                                                }
                                                                return '-';
                                                            }
                                                        },
                                                        {
                                                            id: 'leechers',
                                                            header: '<span style="font-size: 18px" class="fa fa-arrow-circle-down" ></span>',
                                                            width: 70,
                                                            template: function (obj) {
                                                                if (obj.Leechers > -1) {
                                                                    return obj.Leechers;
                                                                }
                                                                return '-';
                                                            }
                                                        },
                                                        {
                                                            id: "category",
                                                            header: "Category",
                                                            width: 100,
                                                            template: function (obj) {
                                                                return CategoriesHelper.GetCategoryTemplate(obj.Group.value, true);
                                                            }
                                                        }, {
                                                            id: "size",
                                                            Header: "Size",
                                                            width: 100,
                                                            template: function (obj) {
                                                                var size = 0;
                                                                for (var i = 0; i < obj.FilesTree.length; i++) {
                                                                    size += obj.FilesTree[i].Size;
                                                                }
                                                                return formatBytes(size, 1);
                                                            }
                                                        }
                                                    ],
                                                    on: {
                                                        onAfterSelect: function (data) {

                                                            var record = this.getItem(data.id);
                                                            var filesTable = $$('filesContainer');
                                                            filesTable.clearAll();
                                                            filesTable.parse(record.FilesTree, 'torrentFilesAdapter');
                                                            var titlesList = $$('titlesList');
                                                            titlesList.clearAll();
                                                            titlesList.parse(record.Titles || []);
                                                            $$('torrentDetailContainer').show()
                                                            $$('backButton').show();
                                                        },
                                                        onBeforeLoad: function () {
                                                            if (!$$('torrentListContainer').showProgress) {
                                                                webix.extend($$('torrentListContainer'), webix.ProgressBar);
                                                            }
                                                            $$('torrentListContainer').showProgress({
                                                                type: "icon"
                                                            });


                                                        },
                                                        onAfterLoad: function () {
                                                            //var torrentsList = $$("torrentsList");
                                                            $$('torrentListContainer').hideProgress({
                                                                type: "icon"
                                                            });
                                                        }
                                                    }
                                                }
                                            ]

                                        }
                                    ]


                                },
                                {
                                    id: "torrentDetailContainer",
                                 //   view:"scrollview",
                                 //   body: {
                                        rows: [
                                            {
                                                id: 'titlesList',
                                                view: 'activeDataView',
                                                minHeight: 350,
                                                activeContent: {
                                                    voteUp: {
                                                        view: 'button',
                                                        type: 'icon',
                                                        icon: 'thumbs-o-up',
                                                        width: 38,
                                                        css: 'align-right vote-btn',
                                                        tooltip: 'How appropriate is this description'
                                                    },
                                                    voteDown: {
                                                        view: 'button',
                                                        type: 'icon',
                                                        icon: 'thumbs-o-down',
                                                        width: 38,
                                                        css: 'align-right vote-btn',
                                                        tooltip: 'How appropriate is this description'
                                                    }
                                                },
                                                type:{
                                                    template:
                                                    '<img class="poster" src="#PosterUrl#" align="left">' +
                                                    '<div class="webix_view webix_section"><div class="webix_template align-left">#Title#</div><div class="webix_template title-year"><span class="webix_icon fa-calendar"></span>#Year#</div></div>' +
                                                    '<div>{common.voteUp()}{common.voteDown()}</div>' +
                                                    '<div class="webix_template">#Description#</div>',
                                                    width:"auto",
                                                    height: 340
                                                },
                                                xCount: 2,
                                                scroll: 'y'
                                            },
                                            {
                                                id: "filesContainer",
                                                datatype: 'torrentFilesAdapter',
                                                view: 'treetable',

                                                minHeight: 100,
                                                pager:'filesPagerContainer',
                                                columns: [
                                                    {
                                                        id: "Name",
                                                        header: "Path",
                                                        fillspace: 90,
                                                        template: function (item, common) {
                                                            /*if (item.Children) {*/
                                                            return common.treetable(item, common) + item.Name;
                                                            /*} else {
                                                             return common.space(item, common) + '<i class="fa treetable-margin '+ item.icon + '"></i>' + item.Name;
                                                             }*/
                                                        }
                                                    },
                                                    {
                                                        id: "Size",
                                                        header: "Size",
                                                        fillspace: 10,
                                                        template: function (item) {
                                                            return formatBytes(item.Size)
                                                        }
                                                    }
                                                ]

                                            },
                                            {
                                                id: "filesPagerContainer",
                                                view: 'pager',
                                                size: 10,
                                                group: 5,
                                                animate: true,
                                                template: '{common.first()} {common.prev()} {common.pages()} {common.next()} {common.last()}',
                                            }

                                        ]
                              //      }


                                }
                            ]

                        }]
                }
            ]
        })
        ;
        webix.ajax('/categories/', function (text, formatter) {
            var menu = formatter.json();
            for (i = 0; i < menu.length; i++) {
                if (menu[i].data) {
                    for (j = 0; j < menu[i].data.length; j++) {
                        menu[i].data[j].value = menu[i].data[j].value.replace(menu[i].value + '\\', '')
                    }
                    menu[i].data.splice(0, 0, {
                        Id: menu[i].Id,
                        icon: menu[i].icon,
                        value: menu[i].value
                    })
                }
            }
            menu.push({
                Id: 0,
                icon: "globe",
                value: "All"
            });
            menu.push({
                id: 212,
                icon: "bar-chart",
                value: "Stats"
            });
            menu.push({
                id: 312,
                icon: "info",
                value: "About"
            });

            $$('sidebar').parse(menu);
        });

        $$("search").attachEvent("onTimedKeyPress", function () {
            //get user input value
            var value = this.getValue().toLowerCase();
            if (this._previousValue != value) {
                this._previousValue = value;
                performSearch(value);
                if (value) {

                    routes.navigate('search/' + value);
                } else {
                    routes.navigate('');
                }
            }

        });

        var torrentOptions = {
            useEasing: true,
            useGrouping: true,
            separator: ',',
            decimal: '.',
            prefix: 'Torrents: ',
            suffix: ''
        };
        var filesOptions = {
            useEasing: true,
            useGrouping: true,
            separator: ',',
            decimal: '.',
            prefix: 'Files: ',
            suffix: ''
        };
        var torrentsCounter = new CountUp("torrentsCountUp", 0, 0, 0, 2.5, torrentOptions);
        torrentsCounter.start();
        var filesCounter = new CountUp("filesCountUp", 0, 0, 0, 2.5, filesOptions);
        filesCounter.start();
        function updateCounters() {
            webix.ajax('/torrents/count/', function (data, formatter) {
                var json = formatter.json();
                torrentsCounter.update(json.TorrentCount);
                filesCounter.update(json.FileCount);
                json = null;
            })
        }

        setTimeout(updateCounters, 150);
        setInterval(updateCounters, 5000);

        Backbone.history.start();
    });
</script>